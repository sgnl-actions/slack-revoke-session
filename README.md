# Slack Revoke Session Action

This action revokes all active sessions for a Slack user by looking up the user by email and resetting their sessions.

## Quick Start

1. **Clone** this repository locally
2. **Install dependencies**: `npm install`
3. **Configure** your Slack API credentials
4. **Test locally**: `npm run dev`
5. **Run tests**: `npm test`
6. **Build**: `npm run build`
7. **Release**: Create a git tag and push

## Input Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `userEmail` | String | Yes | The email address of the Slack user whose sessions should be revoked |
| `delay` | Duration | No | Delay between API calls (e.g., 100ms, 1s). Default: 100ms |
| `address` | String | No | Slack API base URL (e.g., https://slack.com) |

## Development

### Local Testing

```bash
# Run the script locally with mock data
npm run dev

# Run unit tests
npm test

# Watch mode for development
npm run test:watch
npm run build:watch

# Validate metadata
npm run validate

# Lint code
npm run lint
npm run lint:fix
```

### File Structure

- `src/script.mjs` - Main job implementation (⚠️ **Edit this!**)
- `metadata.yaml` - Job schema and configuration (⚠️ **Edit this!**)
- `tests/script.test.js` - Unit tests
- `dist/index.js` - Built script (generated by `npm run build`)
- `scripts/` - Development utilities

## Output

The action returns the following information:

| Field | Type | Description |
|-------|------|-------------|
| `userEmail` | String | The email address that was processed |
| `userId` | String | The Slack user ID that was resolved from the email |
| `sessionsRevoked` | Boolean | Whether the sessions were successfully revoked |
| `revokedAt` | DateTime | When the revocation completed (ISO 8601) |

## How It Works

This action revokes Slack sessions by:
1. Looking up the user by email address using the Slack API
2. Waiting for a configurable delay (default: 100ms)
3. Resetting all active sessions for that user

The delay between API calls helps avoid rate limiting.

## Event Handlers

Your script must export a default object with these handlers:

### `invoke` (Required)
Main execution logic for your job.

```javascript
invoke: async (params, context) => {
  // Your job logic here
  return {
    status: 'success',
    // ... other outputs
  };
}
```

### `error` (Optional)
Error recovery logic when `invoke` fails.

```javascript
error: async (params, context) => {
  // params.error contains the original error
  // Attempt recovery or cleanup
  return {
    status: 'recovered',
    // ... recovery results
  };
}
```

### `halt` (Optional)  
Graceful shutdown when job is cancelled or times out.

```javascript
halt: async (params, context) => {
  // params.reason contains halt reason
  // Clean up resources, save partial progress
  return {
    status: 'halted',
    cleanup_completed: true
  };
}
```

## Context Object

The `context` parameter provides access to:

```javascript
{
  env: {
    ENVIRONMENT: "production",
    // ... other environment variables
  },
  secrets: {
    API_KEY: "secret-key",
    // ... other secrets
  },
  outputs: {
    "previous-job-step": {
      // ... outputs from previous jobs in workflow
    }
  }
}
```

## Testing

### Unit Tests

Tests are in `tests/script.test.js`. Update the mock data to match your job's inputs:

```javascript
const params = {
  target: 'your-target',
  action: 'your-action'
  // ... other inputs
};
```

### Local Development

Use `npm run dev` to test your script locally with mock data. Update `scripts/dev-runner.js` to customize the test parameters.

## Deployment

1. **Ensure tests pass**: `npm test`
2. **Validate metadata**: `npm run validate`  
3. **Build distribution**: `npm run build`
4. **Create git tag**: `git tag v1.0.0`
5. **Push to GitHub**: `git push origin v1.0.0`

## Usage Example

```json
{
  "id": "slack-revoke-session-123",
  "type": "nodejs-20",
  "script": {
    "repository": "github.com/sgnl-actions/slack-revoke-session",
    "version": "v1.0.0",
    "type": "nodejs"
  },
  "script_inputs": {
    "userEmail": "user@example.com",
    "delay": "100ms",
    "address": "https://slack.com"
  },
  "environment": {
    "ADDRESS": "https://slack.com"
  },
  "secrets": {
    "BEARER_AUTH_TOKEN": "your-slack-api-token"
  }
}
```

## Authentication

This action requires a Slack API Bearer token with the following scopes:
- `users:read.email` - To look up users by email
- `admin.users:write` - To reset user sessions

Configure the token using the `BEARER_AUTH_TOKEN` secret or `OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN` for OAuth.

## Support

